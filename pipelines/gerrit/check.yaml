resource_types: ###############################################################

- name: gerrit
  type: docker-image
  source:
    repository: us.gcr.io/concourse-resources/gerrit-resource

resources: ####################################################################

- name: src
  type: gerrit
  source:
    url: https://review.openswitch.net
    username: ((gerrit.username))
    password: ((gerrit.password))
    digest_auth: true
    query: "status:open"

jobs: #########################################################################

- name: check
  max_in_flight: 8
  public: true
  plan:
  - get: src
    version: every
    trigger: true
  - aggregate:
    - task: build
      attempts: 3
      privileged: true
      file: src/.ci/build.yaml
      on_success:
        put: src
        params:
          repository: src
          message: "Build ci/${BUILD_TEAM_NAME}/${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME} succeeded!"
          labels: {Verified: 2}
      on_failure:
        put: src
        params:
          repository: src
          message: "Build ci/${BUILD_TEAM_NAME}/${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME} failed."
          labels: {Verified: -1}
    - try:
        task: lint
        file: src/.ci/lint.yaml
        on_success:
          put: src
          params:
            repository: src
            message: "Lint ci/${BUILD_TEAM_NAME}/${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME} succeeded!"
            labels: {Code-Style: 1}
        on_failure:
          put: src
          params:
            repository: src
            message: "Lint ci/${BUILD_TEAM_NAME}/${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME} Failed."
            labels: {Code-Style: -1}
