resources: ####################################################################

## Source repository ##

- name: rootfs
  type: git
  source:
    uri: https://github.com/open-switch/rootfs
    branch: master
    tag_filter: "[[:digit:]]*.[[:digit:]]*.[[:digit:]]*"

## CI configuration ##

- name: concourse
  type: git
  source:
    uri: https://github.com/open-switch/infra_concourse
    branch: master

## Artifacts ##

- name: jessie-rootfs-tarball
  type: s3
  source:
    bucket: archive.openswitch.net
    regexp: "rootfs/opx-rootfs_(.*-jessie)_amd64.tar.gz"
    region_name: us-west-2
    access_key_id: ((aws-s3.access-key))
    secret_access_key: ((aws-s3.secret-key))

- name: stretch-rootfs-tarball
  type: s3
  source:
    bucket: archive.openswitch.net
    regexp: "rootfs/opx-rootfs_(.*-stretch)_amd64.tar.gz"
    region_name: us-west-2
    access_key_id: ((aws-s3.access-key))
    secret_access_key: ((aws-s3.secret-key))

- name: rootfs-image
  type: docker-image
  source:
    repository: opxhub/rootfs
    username: ((docker.username))
    password: ((docker.password))

jobs: #########################################################################

- name: release-jessie
  public: true
  plan:
  - aggregate:
    - get: rootfs
      trigger: true
    - get: concourse
  - task: build
    attempts: 2
    privileged: true
    file: concourse/tasks/rootfs/task.yaml
    params:
      DIST: jessie
  - put: jessie-rootfs-tarball
    params:
      file: rootfs-artifacts/opx-rootfs_*_amd64.tar.gz
      acl: public-read

- name: release-stretch
  public: true
  plan:
  - aggregate:
    - get: rootfs
      trigger: true
    - get: concourse
  - task: build
    attempts: 2
    privileged: true
    file: concourse/tasks/rootfs/task.yaml
    params:
      DIST: stretch
  - put: stretch-rootfs-tarball
    params:
      file: rootfs-artifacts/opx-rootfs_*_amd64.tar.gz
      acl: public-read

- name: release-jessie-docker
  public: true
  plan:
  - aggregate:
    - get: jessie-rootfs-tarball
      trigger: true
      passed: [release-jessie]
    - get: rootfs
      passed: [release-jessie]
    - get: concourse
  - task: rootfs-image-prep
    file: concourse/tasks/rootfs-image-prep/task.yaml
    params:
      DIST: jessie
    input_mapping:
      rootfs-tarball: jessie-rootfs-tarball
  - put: rootfs-image
    params:
      import_file: rootfs-artifacts/rootfs.tar.gz
      tag: rootfs-artifacts/version
      additional_tags: rootfs-artifacts/tags
      tag_as_latest: true
