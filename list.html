<!DOCTYPE html>
<html>
  <head>
    <title>OPX Archive</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
@import url('https://fonts.googleapis.com/css?family=Source+Code+Pro:400');

body {
  margin: 0 auto;
  max-width: 50em;
  font-family: 'Source Code Pro', monospace;
  font-size: 14px;
  line-height: 1.2;
  padding: 0em 1em;
  color: #333;
  background-color: #eee;
}

h1, h2 {
  color: #f77102;
}

dt {
  margin-top: 10px;
  font-size: 18px;
  color: #999;
}

a:link, a:visited {
  color: #333;
  text-decoration: none;
}

a:hover, a:active {
  color: #e81c4f;
  text-decoration: none;
}
    </style>
  </head>

  <body>
    <h2>OPX Archive</h2>
    <script>
      var bucket = 'archive.openswitch.net'
      var urlSuffix = '.s3.us-west-2.amazonaws.com'
      var url = 'http://' + bucket + urlSuffix;

      // TODO: use this to create HTML *after* looping
      var filesMap = {}

      fetch(url).then(res => {
        res.text().then(text => {
          var parser = new DOMParser();
          var dom = parser.parseFromString(text, 'text/xml');

          var directory = ''
          var directoryListing = document.createElement('dl')

          var release = ''
          var releaseListing = document.createElement('dl')
          var releaseOuter = document.createElement('dd')

          dom.childNodes.forEach((resultList, index, listObj) => {
            resultList.childNodes.forEach((contents, index1, listObj1) => {
              contents.childNodes.forEach((file, index2, listObj2) => {
                if (file.localName === 'Key' && file.textContent !== 'index.html' && file.textContent !== 'list.html') {
                  var fileName = file.textContent
                  var newDirectory = fileName.split('/')[0]
                  var url = 'http://' + bucket + '/' + fileName
                  var thisFile = document.createElement('dd')

                  // add name of directory before listing
                  if (newDirectory != directory) {
                    if (directory != '') {
                      if (release != '') {
                        releaseOuter.appendChild(releaseListing)
                        directoryListing.appendChild(releaseOuter)
                        releaseListing = document.createElement('dl')
                        releaseOuter = document.createElement('dd')
                        release = ''
                      }

                      document.body.appendChild(directoryListing)
                      directoryListing = document.createElement('dl')
                      directory = ''
                    }
                    var directoryHeader = document.createElement('dt')
                    directoryHeader.innerHTML = newDirectory
                    directoryListing.appendChild(directoryHeader)
                    directory = newDirectory

                    filesMap[directory] = {}
                  }

                  // remove top-level directory from file name text
                  if (fileName.split('/').length > 1) {
                    fileName = fileName.split('/').slice(1).join('/')
                  }

                  if (/^\d+\.\d+\.\d+/.test(fileName) || /^stable\//.test(fileName) || /^unstable\//.test(fileName)) {
                    topDir = fileName.split('/').slice(0, 1)[0]
                    if (topDir != release) {
                      if (release != '') {
                        releaseOuter.appendChild(releaseListing)
                        directoryListing.appendChild(releaseOuter)
                        releaseListing = document.createElement('dl')
                        releaseOuter = document.createElement('dd')
                        release = ''
                      }
                      var releaseHeader = document.createElement('dt')
                      releaseHeader.innerHTML = topDir
                      releaseListing.appendChild(releaseHeader)
                      release = topDir

                      filesMap[directory][release] = []
                    }

                    fileName = fileName.split('/').slice(1).join('/')
                    thisFile.innerHTML = '<a href="' + url + '">' + fileName + '</a>'
                    releaseListing.appendChild(thisFile)

                    filesMap[directory][release].push(fileName)
                  } else {
                    thisFile.innerHTML = '<a href="' + url + '">' + fileName + '</a>'
                    directoryListing.appendChild(thisFile)

                    if (Object.keys(filesMap[directory]).length === 0) {
                      filesMap[directory] = []
                    }
                    filesMap[directory].push(fileName)
                  }

                }
              })
            })
          })

          if (directory != '') {
            if (release != '') {
              releaseOuter.appendChild(releaseListing)
              directoryListing.appendChild(releaseOuter)
            }

            document.body.appendChild(directoryListing)
          }

        })
      })

      console.log(filesMap)
    </script>
  </body>
</html>
