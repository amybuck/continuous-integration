name: github
description: OpenSwitch GitHub organization
repository: "https://github.com/open-switch/github"
skip_queued_branch_builds: true
skip_queued_branch_builds_filter: "!master"
provider_settings:
  build_pull_request_forks: true
  build_pull_requests: true
  build_tags: false
  prefix_pull_request_fork_branch_names: true
  publish_commit_status: true
  publish_commit_status_per_step: false
  pull_request_branch_filter_enabled: false
  skip_pull_request_builds_for_existing_commits: true
  trigger_mode: "code"
env:
  TF: "'docker run -it -w /tf -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e TF_VAR_github_access_token'"
steps:
  - name: ":terraform: plan"
    type: script
    agent_query_rules: [ "queue=deploy" ]
    artifact_paths: tfplan
    concurrency: 1
    concurrency_group: "terraform/github"
    command: |
      $TF -v $(pwd):/tf hashicorp/terraform init -input=false
      $TF -v $(pwd):/tf hashicorp/terraform plan -input=false -out=tfplan
  - type: waiter
  - name: ":terraform: apply"
    type: script
    branch_configuration: "master"
    agent_query_rules: [ "queue=deploy" ]
    concurrency: 1
    concurrency_group: "terraform/github"
    command: |
      buildkite-agent artifact download tfplan .
      $TF -v $(pwd):/tf hashicorp/terraform init -input=false
      $TF -v $(pwd):/tf hashicorp/terraform apply -input=false tfplan
